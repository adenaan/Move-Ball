<script>
  let socket;
  let playerIndex = null;
  let tapCooldown = false;
  let rememberName = false;
  const ballEl = document.getElementById("ball");
  const statusEl = document.getElementById("status");
  const startScreen = document.getElementById("startScreen");
  const gameScreen = document.getElementById("gameScreen");
  const nameInput = document.getElementById("nameInput");
  const rememberCheckbox = document.getElementById("rememberCheckbox");
  const startBtn = document.getElementById("startBtn");
  const tapBtn = document.getElementById("tapButton");
  const p1score = document.getElementById("p1score");
  const p2score = document.getElementById("p2score");
  const result = document.getElementById("result");
  let currentNames = ["P1", "P2"];

  // Sound setup
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const beep = (freq = 440, duration = 0.1, vol = 0.3) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.frequency.value = freq;
    o.type = "sine";
    o.connect(g);
    g.connect(ctx.destination);
    g.gain.value = vol;
    o.start();
    o.stop(ctx.currentTime + duration);
  };

  function connect() {
    socket = new WebSocket("wss://move-ball-server.glitch.me");

    socket.onopen = () => {
      statusEl.textContent = "Connected! Enter your name to play.";
      const storedName = localStorage.getItem("playerName");
      const remember = localStorage.getItem("remember") === "true";
      rememberCheckbox.checked = remember;
      rememberName = remember;

      if (remember && storedName) {
        nameInput.value = storedName;
      } else {
        nameInput.value = '';
      }
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "init") {
        playerIndex = data.playerIndex;
        currentNames = data.names;
        updateScores(data.scores, data.names);
        updateBall(data.ball);
        statusEl.textContent = "Waiting for other player...";
      }

      if (data.type === "names" && data.names) {
        updateScores(null, data.names);
      }

      if (data.type === "start") {
        result.style.display = "none";
        updateBall(data.ball);
        updateScores(data.scores, data.names || currentNames);
      }

      if (data.type === "ball") {
        updateBall(data.position);
      }

      if (data.type === "win") {
        updateScores(data.scores, currentNames);
        showResult(data.winner === playerIndex ? "You Win!" : "You Lose!");
        beep(data.winner === playerIndex ? 880 : 220, 0.2, 0.4); // win/loss beep
      }

      if (data.type === "reset") {
        updateBall(0);
      }
    };

    socket.onclose = () => {
      statusEl.textContent = "Disconnected. Refresh to reconnect.";
      alert("Disconnected from server. Please refresh.");
    };

    socket.onerror = (e) => {
      console.error("WebSocket error", e);
      statusEl.textContent = "Connection error.";
    };
  }

  function updateBall(pos) {
    const percent = 50 + pos * 10;
    ballEl.style.left = `${percent}%`;
  }

  function updateScores(scores, names) {
    if (scores) {
      currentNames = names || currentNames;
      p1score.textContent = `${currentNames[0]}: ${scores[0]}`;
      p2score.textContent = `${currentNames[1]}: ${scores[1]}`;
    } else if (names) {
      currentNames = names;
      const s1 = p1score.textContent.split(":")[1].trim();
      const s2 = p2score.textContent.split(":")[1].trim();
      p1score.textContent = `${names[0]}: ${s1}`;
      p2score.textContent = `${names[1]}: ${s2}`;
    }
  }

  function showResult(msg) {
    result.textContent = msg;
    result.style.display = "block";
    setTimeout(() => result.style.display = "none", 2500);
  }

  rememberCheckbox.onchange = () => {
    rememberName = rememberCheckbox.checked;
    localStorage.setItem("remember", rememberName);
  };

  startBtn.onclick = () => {
    const name = nameInput.value.trim() || "Player";
    if (rememberName) {
      localStorage.setItem("playerName", name);
    } else {
      localStorage.removeItem("playerName");
    }
    socket.send(JSON.stringify({ type: "name", name }));
    startScreen.style.display = "none";
    gameScreen.style.display = "flex";
  };

  tapBtn.ontouchstart = tapBtn.onclick = (e) => {
    e.preventDefault();
    if (tapCooldown) return;
    tapCooldown = true;
    socket.send(JSON.stringify({ type: "tap" }));
    beep(600, 0.1, 0.2); // tap sound
    setTimeout(() => { tapCooldown = false; }, 150);
  };

  document.addEventListener('gesturestart', (e) => e.preventDefault());
  document.addEventListener('dblclick', (e) => e.preventDefault());

  connect();
</script>
